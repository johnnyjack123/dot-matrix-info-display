<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Connect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <style>
    html, body {
        height: 100%;
        overflow-y: auto;
    }

    .form-container-connect-wrapper {
        min-height: 100vh;
    }

    /* Fade-in Animation mit Opacity */
    #additional-form {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.8s ease-in-out, max-height 0.8s ease-in-out;
    }

    #additional-form.show {
        opacity: 1;
        max-height: 1000px;
    }
</style>

</head>
<body>
<div class="form-container-connect-wrapper">
    <div class="form-settings-container">
        <h1 class="header_small" id="status-header">Waiting for connection to ESP...</h1>

        <div class="spinner-wrapper" id="spinner">
            <div class="spinner"></div>
        </div>

        <p class="form-label" id="info-text">
            {% if connection_state %}
            You have to connect your ESP to this computer. The ESP needs to be flashed with the latest Dot-Matrix_Main_Arduino.ino file via the
            <a href="https://www.arduino.cc/en/software/">Arduino IDE</a>. You may have to wait a few seconds - after connecting you will be redirected to the dashboard.
            {% else %}
            ESP already configured.
            {% endif %}
        </p>

        <div id="button-container">
            {% if connection_state %}
            <!-- <a href="/initial_connect" class="btn btn-outline-light">Connect</a> -->
            {% else %}
            <a href="/dashboard" class="btn btn-outline-light">Skip connection</a>
            {% endif %}
        </div>

        <!-- Dynamisches Formular (wird nach 5 Sekunden angezeigt) -->
        <div id="additional-form" style="margin-top: 20px;">
            <h3 class="header_small">Additional Configuration</h3>
            <p class="form-label">If the connection can´t be established you can edit your credentials or even erase your probably wrong credentials on the ESP. So you can start completely fresh.</p>
            <form id="edit_credentials" action="/edit_credentials" method="POST">
                <div class="mb-3">
                    <label for="ssid" class="form-label">SSID</label>
                    <input type="text" class="form-control" id="ssid" name="ssid" placeholder="Enter SSID of your WIFI">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="text" class="form-control" id="password" name="password" placeholder="Enter password of your WIFI">
                </div>
                <div id="validation-error" class="text-danger" style="display: none; margin-bottom: 10px;">
                    Both fields must be filled if one is filled!
                </div>
                <button type="submit" class="btn btn-primary">Change password</button>
                <button type="button" class="btn btn-secondary" id="other-route-btn">Erase credentials on ESP</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script type="text/javascript">
    var socket = io();
    var isConnected = false;

    socket.on('connect', function() {
        console.log('Connected with server');
        socket.emit('request_esp_status');
    });

    // WICHTIG: Fängt ALLE eingehenden Events ab
    socket.onAny((eventName, ...args) => {
        console.log('=== Received ANY event ===');
        console.log('Event name:', eventName);
        console.log('Event data:', args);
    });

    socket.on('esp_connection_status', function(data) {
        console.log('ESP Status Handler called:', data);
        console.log('Type of data:', typeof data);
        console.log('data.connected:', data.connected);
        console.log('Is array?', Array.isArray(data));

        // Falls data ein Array ist, nimm das erste Element
        var status = Array.isArray(data) ? data[0] : data;
        console.log('Actual status object:', status);

        if (status.connected) {
            isConnected = true;
            document.getElementById('status-header').innerText = '✓ ESP connected!';
            document.getElementById('status-header').style.color = '#2ecc71';
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('info-text').innerText = 'Connection successfully established.';

            setTimeout(function() {
                window.location.href = "/dashboard";
            }, 2000);
        } else {
            document.getElementById('status-header').innerText = 'Waiting for connection to ESP...';
            document.getElementById('status-header').style.color = '#fff';
        }
    });

    socket.on('disconnect', function() {
        console.log('Vom Server getrennt');
    });

    // Show form after 5 seconds with smooth fade-in
    setTimeout(function() {
        var formDiv = document.getElementById('additional-form');
        formDiv.classList.add('show');
    }, 5000);

    // Validierung before submit
    document.getElementById('edit_credentials').addEventListener('submit', function(e) {
        var ssid = document.getElementById('ssid').value.trim();
        var password = document.getElementById('password').value.trim();
        var validationError = document.getElementById('validation-error');

        // Validierung: Wenn ein Feld ausgefüllt ist, muss das andere auch ausgefüllt sein
        if ((ssid && !password) || (!ssid && password)) {
            e.preventDefault();
            validationError.style.display = 'block';
            return false;
        } else {
            validationError.style.display = 'none';
            // Formular wird normal submitted
        }
    });

    // Erase credentials button
    document.getElementById('other-route-btn').addEventListener('click', function() {
        window.location.href = '/erase_credentials_on_esp';
    });
</script>
</body>
</html>
